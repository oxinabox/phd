\documentclass[landscape]{article}
\usepackage[a3paper]{geometry}

\input{../../preamble-tikz.tex}

\begin{document}

\numdef{\n}{8}
\numdef{\labelwidth}{5.5cm}
%%%%%%%%%%%%%%%%%%%%%%%%%
% Encoder

\begin{tikzpicture}[]

\begin{scope}
	\node(lblEncoder)[text width= \labelwidth] {\textbf{RNN Encoder:}\\%
	Variable $n$ inputs: $x_t$\\%
	1 output: $\hat{y}$ \\%
	};
	
	\coordinate (L0) at (lblEncoder.east);
	
	\foreach \i[count=\j from 0] in {1,...,\n}{
		\ifnumequal{\i}{\n - 1}{%
			\node(L\i)[dashed, layer, right = of L\j] {...};
			\node(w\i)[below = of L\i]{...};
		}%
		{	
			\node(L\i)[layer, right = of L\j] {RU};
			\node(w\i)[below = of L\i]{\ifnumequal{\i}{\n}{$x_n$}{$x_\i$}};
			\draw[->](w\i) -- (L\i);
		}
	}
	\foreach \i[count=\j from 1] in {2,...,\n} {
		\draw[->] (L\j) edge node[labe]{state} (L\i);
	}
	
	\node(out) [above = of L\n]{$\hat{y}$};
	\draw[->] (L\n) -- (out);
\end{scope}

%%%%%%%%%%%%%%%%
 Decoder
\begin{scope}[yshift=-5cm] 
\node(lbl)[text width= \labelwidth] {\textbf{RNN Decoder:}\\%
1 input: $x$\\%
variable $m$ outputs: $\hat{y_t}$ \\%
with prompts: $r_t$ (often $y_{t-1}$)
};

\coordinate (L0) at (lbl.east);
\coordinate (L1c)[right = of L0];
\node(x)[below right = 4 of L1c]{$x$};

\foreach \i[count=\j from 0] in {1,...,\n}{
	\ifnumequal{\i}{\n - 1}{%
		\node(L\i)[dashed, layer, right = of L\j] {...};
		\node(w\i)[above = of L\i]{...};
		\node(y\i)[below = of L\i]{...};
	}%
	{	
		\node(L\i)[layer, right = of L\j] {RU};
		\node(v\i)[above = of L\i]{\ifnumequal{\i}{\n}{$\hat{y}_m$}{$\hat{y}_\i$}};
		\node(w\i)[below = of L\i]{$[r_\i;x]$};
		\draw[->](w\i) -- (L\i);
		\draw[->](L\i) -- (v\i);
		\draw[->](x) to[bend right = 5] (w\i.300);
	}
}
\foreach \i[count=\j from 1] in {2,...,\n} {
	\draw[->] (L\j) edge node[labe]{state} (L\i);
}

\end{scope}

%%%%%%%%%%%%%%%%%
 Encoder Decoder

\begin{scope}[yshift=-14cm]
\node(lbl)[text width= \labelwidth] {\textbf{RNN Encoder-Decoder:}\\%
Variable $n$ inputs: $x_t$\\%
Variable $m$ outputs $\hat{y_t}$\\%
Prompts: $r_t$ (often $y_{t-1}$)
};

\coordinate (L0) at (lbl.east);
\numdef{\nn}{4}
\foreach \i[count=\j from 0] in {1,...,\nn}{
	\ifnumequal{\i}{\nn - 1}{%
		\node(L\i)[dashed, layer, right = of L\j] {...};
		\node(w\i)[below = of L\i]{...};
	}%
	{
		\node(L\i)[layer, right = of L\j] {$\mathrm{RU_E}$};
		\node(w\i)[below = of L\i]{\ifnumequal{\i}{\nn}{$x_n$}{$x_\i$}};
		\draw[->] (w\i) -- (L\i);
	}
}
\foreach \i[count=\j from 1] in {2,...,\nn} {
	\draw[->] (L\j) edge node[labe] {state} (L\i);
}




\coordinate[above = 3 of L\nn] (Lp\nn);
\numdef{\np}{\n - 1}
\foreach \j in {\nn,...,\np}{
	\numdef{\i}{\j+1}
	\numdef{\y}{\i - \nn}
	\ifnumequal{\i}{\n-1}{%
		\node(Lp\i)[dashed, layer, right = of Lp\j] {...};
		\node(w\i)[below = of Lp\i]{...};
		\node(y\i)[above = of Lp\i]{...};
	}%
	{
		\node(Lp\i)[layer, right = of Lp\j] {$\mathrm{RU_D}$};
		\ifnumequal{\i}{\n}{
			\node(w\i)[below = of Lp\i]{$[z; r_m]$};
			\node(y\i)[above = of Lp\i]{$\hat{y}_m$};
		}
		{
			\node(w\i)[below = of Lp\i]{$[z; r_\y]$};
			\node(y\i)[above = of Lp\i]{$\hat{y}_\y$};
		}

		\draw[->] (w\i) -- (Lp\i);
		\draw[->] (Lp\i) -- (y\i);
		\path[->] (L\nn.north) edge node[labe]{z} (w\i.south west);
	}
}


\numdef{\nnp1}{\nn + 1}
\foreach \i in {\nnp1,...,\np} {
	\numdef{\j}{\i+1}
	\draw[->] (Lp\i) edge node[labe] {state} (Lp\j);
}
 

\end{scope}


\end{tikzpicture}




\end{document}