\usepackage[subpreambles=false,group=false]{standalone}

\usepackage{geometry}
\geometry{a4paper, inner=3cm, outer=3cm, top=2cm, bottom=2cm}



\usepackage{xcolor}
\usepackage{environ}
\usepackage{xparse}
\usepackage{luatex85}

\setlength{\marginparwidth}{2.5cm}
\usepackage[textwidth=2.5cm]{todonotes}



\usepackage{fancyhdr}
\pagecolor{white}
\usepackage{pdfpages}
\usepackage{bookmark}

\usepackage{etoolbox}


\usepackage{booktabs}
\usepackage{tabularx}
\usepackage{pgfplots}
\usepackage{pgfplotstable}
\pgfplotsset{compat=1.15}
\DeclareMathVersion{tabularbold}
\SetSymbolFont{operators}{tabularbold}{OT1}{cmr}{b}{n} %TODO Check this font is right


\usepackage{graphicx}
\graphicspath{{./figs/}, {./}}
\usepackage[space]{grffile}
\usepackage{subfig}

\usepackage{latexsym}
\usepackage[boxed]{algorithm2e}




\input{preamble-math.tex}
\input{preamble-tikz.tex}
\usepackage{cleveref}



%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[
backend=biber,
url=false,  
style=alphabetic,
citestyle=authoryear,
bibstyle=authoryear,
maxbibnames=99,
dashed=false,
refsection=chapter
]{biblatex}

\newcommand{\printbib}{
	\clearpage
	%\loadgeometry{basegeo}
	\printbibliography
	\clearpage
}

\bibliography{master}
\newcommand{\citep}[1]{\parencite{#1}}
\newcommand{\citet}[1]{\textcite{#1}}


%%%%%%%%%%%%%%%%%%%%
% Capture name of the part

\newcommand{\parttitle}{}
\newcommand{\chaptertitle}{}
\makeatletter

\patchcmd{\@part}% <cmd>
{\markboth}% <search>
{\renewcommand{\parttitle}{#1}}% <replace>
{}{}% <success><failure>

\patchcmd{\@chapter}% <cmd>
{\markboth}% <search>
{\renewcommand{\chaptertitle}{#1}}% <replace>
{}{}% <success><failure>
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Page boarders
\newcommand{\backgroundcolor}{white}
\newcommand{\bordercolor}{\backgroundcolor}
\usepackage{tikzpagenodes}
\newcommand{\drawpageborders}{\tikz[remember picture,overlay]{
	\draw [color=\bordercolor, line width=2mm] (current page.south east) rectangle (current page.north east);
	\draw [color=\bordercolor, line width=2mm] (current page.south west) rectangle (current page.north west);
	}
}

%%%%%%
%% Page layout


\fancypagestyle{plain}{%
	\fancyhf{} % clear all header and footer fields
	\fancyfoot[RO,LE]{\thepage}
	\renewcommand{\headrulewidth}{0pt}
	\renewcommand{\footrulewidth}{0pt}}

\pagestyle{fancy}
	\fancyhf{}
	\fancyhead[C]{\drawpageborders{}}
	\fancyhead[L]{\parttitle}
	\fancyhead[R]{\chaptertitle}
	\fancyfoot[RO,LE]{\thepage}



\DeclareDocumentCommand{\includepublication}{O{-} m}{
	\def\pubfile{#2}
	\def\pages{#1}
	
	\label{\pubfile}

	\definecolor{randomcolor}{RGB}
	{
		\pdfuniformdeviate 255,
		\pdfuniformdeviate 255,
		\pdfuniformdeviate 255
	}%
	%\pagecolor{randomcolor!10!white}
	\renewcommand{\bordercolor}{randomcolor}
	\includepdf[%
		pages={#1},% can't use \pages inside []
		%frame=true, %
		scale=0.9, %
		pagecommand={\pagestyle{fancy}}, %
		]{publications/\pubfile.pdf}
	%\nopagecolor
	\renewcommand{\bordercolor}{\backgroundcolor}
}


\DeclareDocumentCommand{\setchapter}{s m}{
	\renewcommand{\chaptertitle}{#2}
	\IfBooleanTF{#1}{
		\addcontentsline{toc}{chapter}{#2}
	}%
	{
		\refstepcounter{chapter}
		\addcontentsline{toc}{chapter}{\protect\numberline{\thechapter}#2}
	}

}

%%%%%

\NewEnviron{preamble}{%
	\cleardoublepage
	\null
	\vspace{1cm}
	{\centering \Huge \chaptertitle\\}
	\vspace{0.5cm}
	\noindent\BODY
}

\makeatletter
\NewEnviron{abstract}{%
	\small
	\begin{center}%
		{\bfseries Abstract\vspace{-.5em}\vspace{\z@}}%
	\end{center}%
	\quotation
	\noindent\BODY
	\endquotation
}
\makeatother


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
\makeatletter % Center all floats
\g@addto@macro\@floatboxreset{\centering}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%


\newcommand{\natlang}[1]{\texttt{#1}}